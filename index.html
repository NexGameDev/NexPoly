<script>
const rollBtn = document.getElementById('rollBtn');
const helpBtn = document.getElementById('helpBtn');
const helpBox = document.getElementById('helpBox');
const turnIndicator = document.getElementById('turnIndicator');
const notification = document.getElementById('notification');
const cardPopup = document.getElementById('cardPopup');

let playerPos = 0;
let computerPos = 0;
const totalTiles = 40;
let isPlayerTurn = true;

const playerToken = document.getElementById('player');
const computerToken = document.getElementById('computer');
const board = document.getElementById('board');
const tiles = Array.from(document.getElementsByClassName('tile'));
const tileSize = board.offsetWidth / 11;

let owners = Array(totalTiles).fill(null);

// ========== FIX: TILE CHECKING SEHARUSNYA TIDAK DIPICU GANDA ==========
function moveToken(token, position, triggerTile = true) {
    const pos = getTilePosition(position);
    token.style.top = pos.top + 'px';
    token.style.left = pos.left + 'px';

    if (triggerTile) {
        setTimeout(() => {
            checkTile(token, position);
        }, 300);
    }
}

function updateNotification(msg) { notification.innerText = msg; }

const chanceCards = [
    {text: "Advance to GO", action: ()=>{
        playerPos = 0;
        moveToken(playerToken, 0, false);
        updateNotification("Player moves to GO");
    }},
    {text: "Pay $50", action: ()=>{ updateNotification("Player pays $50"); }}
];

const communityCards = [
    {text: "Receive $50", action: ()=>{ updateNotification("Player receives $50"); }},
    {text: "Go to Jail", action: ()=>{
        playerPos = 10;
        moveToken(playerToken, 10, false);
        updateNotification("Player goes to Jail");
    }}
];

function getTilePosition(index){
    let row=0,col=0;
    if(index<10){row=0; col=index;}
    else if(index<19){row=index-9; col=10;}
    else if(index<29){row=10; col=28-index;}
    else{row=39-index; col=0;}
    return {top: row*tileSize, left: col*tileSize};
}

// ========== FIX: TILE CHECKING SEKARANG 100% SESUAI TILE ASLI ==========
function checkTile(token, index){
    const tile = tiles[index];
    const label = tile.querySelector('.label').innerText;

    // Property
    if (label.startsWith("Pro")) {
        if (!owners[index] && token.id === "player") {
            if (confirm("Do you want to buy this property?")) {
                owners[index] = "player";
                tile.querySelector('.owner').style.background = 'blue';
            }
        } else if (!owners[index] && token.id === "computer") {
            owners[index] = "computer";
            tile.querySelector('.owner').style.background = 'red';
        } else if (owners[index] && owners[index] !== token.id) {
            updateNotification(token.id === "player" ? "Pay rent to computer" : "Pay rent to player");
        }
    }

    // Cards â€” FIX: hanya menampilkan, tidak memicu tile lain
    if (label === "Cha") showCard(chanceCards);
    if (label === "Com") showCard(communityCards);

    // Special tiles
    if (label === "Jail") updateNotification("Landed on Jail");
    if (label === "Tax") updateNotification("Pay tax $200");
    if (label === "GoJ") updateNotification("Go to Jail");
    if (label === "Free") updateNotification("Free Parking");
}

// ========== FIX: CARD POPUP TIDAK MEMICU TILE LAIN ==========
function showCard(deck){
    const card = deck[Math.floor(Math.random() * deck.length)];
    cardPopup.innerText = card.text;
    cardPopup.style.display = 'block';
    cardPopup.style.top = '200px';
    cardPopup.style.left = '150px';

    cardPopup.onclick = () => {
        card.action();
        cardPopup.style.display = 'none';
        cardPopup.onclick = null;
    };
}

// TURN SYSTEM
rollBtn.addEventListener('click', ()=>{
    if (!isPlayerTurn) return;

    const dice = Math.floor(Math.random()*6)+1;
    playerPos = (playerPos + dice) % totalTiles;
    moveToken(playerToken, playerPos, true);
    turnIndicator.innerText = "Turn: Computer";
    isPlayerTurn = false;

    setTimeout(()=>{
        const compDice = Math.floor(Math.random()*6)+1;
        computerPos = (computerPos + compDice) % totalTiles;
        moveToken(computerToken, computerPos, true);
        turnIndicator.innerText = "Turn: Player";
        isPlayerTurn = true;
    }, 1000);
});

helpBtn.addEventListener('click', ()=>{
    helpBox.style.display = helpBox.style.display==='none'?'block':'none';
});

// Initial placement
moveToken(playerToken, playerPos, false);
moveToken(computerToken, computerPos, false);
</script>
